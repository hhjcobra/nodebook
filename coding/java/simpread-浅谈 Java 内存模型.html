
    <html lang="en" class="simpread-font simpread-theme-root" style="false">
    <head>
        <meta charset="UTF-8">
        <meta name="author" content="Kenshin"/>
        <meta name="description" content="简悦 ( SimpRead ) - 让你瞬间进入沉浸式阅读的 Chrome extension" />
        <meta name="keywords" content="Chrome extension, Chrome 扩展, 阅读模式, 沉浸式阅读, read mode, reading mode, reader view"/>
        <meta name="thumbnail" content="https://simpread-1254315611.cos.ap-shanghai.myqcloud.com/static/introduce-2.png"/>

        <link rel="stylesheet" href="http://sr.ksria.cn/puread/simpread.css"                  type="text/css" media="all">
        <link rel="stylesheet" href="http://sr.ksria.cn/puread/theme_common.css"              type="text/css" media="all">
        <link rel="stylesheet" href="http://sr.ksria.cn/puread/theme_github.css" type="text/css" media="all">

        <style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {letter-spacing: 1px;}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {text-indent: 2px;}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style><style type="text/css" id="simpread-custom-art">sr-rd-content *, sr-rd-content p, sr-rd-content div {}</style><style type="text/css" id="simpread-custom-code">sr-rd-content pre code, sr-rd-content pre code * {}</style><style type="text/css" id="simpread-custom-desc">sr-rd-desc {}</style><style type="text/css" id="simpread-custom-pre">sr-rd-content pre {}</style><style type="text/css" id="simpread-custom-title">sr-rd-title {}</style><style type="text/css" id="simpread-custom-css"></style>
        <title>简悦 | 浅谈 Java 内存模型</title>
        
    </head>
    <body>
        <sr-read style="0">
            <sr-rd-title>浅谈 Java 内存模型</sr-rd-title>
            <sr-rd-desc style="false">Java 内存模型（JMM）描述了 JVM 如何使用计算机的内存（RAM）。JVM 是一个完整计算机的模型，因此该模型包含了内存模型的设计 —— JMM。</sr-rd-desc>
            <sr-rd-content><p>Java 内存模型（JMM）描述了 JVM 如何使用计算机的内存（RAM）。JVM 是一个完整计算机的模型，因此该模型包含了内存模型的设计 —— JMM。</p><p>如果要正确地设计并发程序，了解 JMM 非常重要。JMM 描述了不同线程间如何以及何时可以看到其它线程写入共享变量的值，以及如何在必要时同步访问共享变量。</p><p>最初的 JMM 设计不充分，因此 JMM 在 Java 1.5 进行了修订。此版本的 JMM 仍在 Java 8 中使用。</p><p>JVM 内部使用的 JMM 将内存划分为线程栈和堆。下图从逻辑角度说明了 JMM：</p><p><div class="sr-rd-content-center"><img class="" src="http://misc.linkedkeeper.com/misc/img/blog/201907/linkedkeeper0_20c1e278-cf2d-40ac-a2ad-1f049d0dee61.jpg"></div></p><p>在 JVM 中运行的每个线程都有它自己的线程栈，线程栈包含了线程调用了哪些方法以到达当前执行点的信息，我们把它成为 “调用栈（Call Stack）“。当线程执行其代码时，调用栈会发生变化。</p><p>线程栈还包含了正在执行的每个方法的所有的局部变量（调用栈上的所有方法）。一个线程只能访问它自己的线程栈，由线程创建的局部变量对于创建它的线程以外的所有其他线程都是不可见的。即使两个线程正在执行完全相同的代码，两个线程仍将在各自的线程栈中创建自己的局部变量。因此，每个线程都有自己的每个局部变量的版本。</p><p>基本类型（boolean，byte，short，char，int，long，float，double）完全存储在线程栈里，因此对其他线程是不可见的。一个线程可以将一个基本类型的变量副本传递给另一个线程，但它不能共享原始局部变量本身。</p><p>堆包含了 Java 应用程序中创建的所有对象，不管对象是哪个线程创建的，这包括基本类型的包装版本（如 Byte，Integer，Long 等）。无论对象是创建成局部变量，还是作为另一个对象的成员变量被创建，对象都存储在堆中。</p><p>下图说明了调用栈和局部变量存储在线程栈中，而对象存储在堆中。</p><p><div class="sr-rd-content-center"><img class="" src="http://misc.linkedkeeper.com/misc/img/blog/201907/linkedkeeper0_eee316c2-82f3-4fe4-8cd3-6b875da6aff7.jpg"></div></p><p>局部变量如果是基本类型，这种情况下，变量完全存储在线程栈上。</p><p>局部变量如果是对象的引用，这种情况下，引用（局部变量）存储在线程栈上，但对象本身存储在堆上。</p><p>对象中可能包含方法，而这些方法中可能包含局部变量，这种情况下，即使方法所属的对象存储在堆上，但这些局部变量却是存储在线程栈上的。</p><p>对象的成员变量与对象本身一起存储在堆上，当成员变量是基本类型以及是对象的引用时都是如此。</p><p>静态类型变量与类定义一起存储在堆上。</p><p>所有线程通过拥有对象引用去访问堆中的对象。当一个线程有权访问一个对象时，它也能访问该对象的成员变量。如果两个线程同一时间调用同一对象的一个方法，它们都可以访问该对象的成员变量，但每个线程都有自己局部变量的副本。</p><p>这是一个说明上述要点的图表：</p><p><div class="sr-rd-content-center"><img class="" src="http://misc.linkedkeeper.com/misc/img/blog/201907/linkedkeeper0_f32061a0-951e-4820-bc90-66717f69c3cc.jpg"></div></p><p>两个线程各有一组局部变量，其中一个局部变量（Local Variable 2）指向堆中的共享对象（Object 3）。两个线程各自对同一各对象拥有不同的引用，它们的引用是局部变量，因此它们存储在各自线程的线程栈中。但是，这两个不同引用指向堆中的同一个对象。</p><p>请注意，共享对象（Object 3）将 Object 2 和 Object 4 作为成员变量引用（如从 Object 3 到 Object 2 和 Object 4 的箭头所示），通过对象 3 中的这些成员变量引用，两个线程可以访问对象 2 和 对象 4。</p><p>上图还显示了一个局部变量指向堆中的两个不同对象。这种情况下，引用指向两个不同的对象（Object 1 和 Object 5），而不是同一个对象。理论上，如果两个线程都引用了两个对象，那两个线程都可以访问对象 1 和 对象 5。但在上图中，每个线程只引用了两个对象中的一个。</p><p>那么，什么样的 Java 代码可以导致上面的内存图？好吧，代码就如下面的代码一样简单：</p><pre>public class MyRunnable implements Runnable() {

    public void run() {
        methodOne();
    }

    public void methodOne() {
        int localVariable1 = 45;

        MySharedObject localVariable2 =
            MySharedObject.sharedInstance;

        

        methodTwo();
    }

    public void methodTwo() {
        Integer localVariable1 = new Integer(99);

        
    }
}

</pre><pre>public class MySharedObject {

    

    public static final MySharedObject sharedInstance =
        new MySharedObject();


    

    public Integer object2 = new Integer(22);
    public Integer object4 = new Integer(44);

    public long member1 = 12345;
    public long member1 = 67890;
}

</pre><p>如果两个线程正在执行 <code>run()</code> 方法，则前面的结果就会出现。<code>run()</code> 方法会调用 <code>methodOne()</code>，而 <code>methodOne()</code> 会调用 <code>methodTwo()</code>。</p><p>方法 <code>methodOne()</code> 中声明了一个基本类型的局部变量（localVariable1 类型 int）和一个对象引用的局部变量（localVariable2）。</p><p>每个执行 <code>methodOne()</code> 的线程将在各自的线程栈上创建自己的 localVariable1 和 localVariable2 副本。localVariable 1 变量将完全分离，只存在于每个线程的线程栈中。一个线程无法看到另一个线程对其 localVariable 1 副本所做的更改。</p><p>执行 <code>methodOne()</code> 的每个线程还将创建它们自己的 localVariable2 副本。然而，localVariable 2 的两个不同副本最终都指向堆上的同一个对象。代码将 localVariable 2 设置为指向静态变量引用的对象。静态变量只有一个副本，这个副本存储在堆上。因此，localVariable 2 的两个副本最终都指向静态变量所指向的 MySharedObject 的同一个实例。MySharedObject 实例也存储在堆中，它对应于上图中的对象 3。</p><p>注意 MySharedObject 类也包含两个成员变量。成员变量本身同对象一起存储在堆中。这两个成员变量指向另外两个 Integer  对象，这些 Integer 对象对应于上图中的对象 2 和对象 4。</p><p>还要注意 <code>methodTwo()</code> 创建的一个名为 localVariable 1 的本地变量。这个局部变量是一个指向 Integer 对象的对象引用。该方法将 localVariable 1 引用设置为指向一个新的 Integer 实例。localVariable 1 引用将存储在每个执行 <code>methodTwo()</code> 的线程的一个副本中。实例化的两个 Integer 对象存储在堆上，但是由于方法每次执行都会创建一个新的 Integer 对象，因此执行该方法的两个线程将创建单独的 Integer 实例。<code>methodTwo()</code> 中创建的 Integer 对象对应于上图中的对象 1 和对象 5。还要注意类 MySharedObject 中的两个成员变量，它们的类型是 long，这是一个基本类型。由于这些变量是成员变量，所以它们仍然与对象一起存储在堆中。只有本地变量存储在线程堆栈中。</p><p>现代硬件内存架构与 Java 内存模型略有不同。了解硬件内存架构也很重要，以了解 Java 内存模型如何与其一起工作。本节介绍了常见的硬件内存架构，后面的部分将介绍 Java 内存模型如何与其配合使用。</p><p>这是现代计算机硬件架构的简化图：</p><p><div class="sr-rd-content-center"><img class="" src="http://misc.linkedkeeper.com/misc/img/blog/201907/linkedkeeper0_e9769825-fc70-4e4a-958a-17b27cadb9f9.jpg"></div></p><p>现代计算机通常有两个或更多的 CPU，其中一些 CPU 也可能有多个内核。关键是，在具有 2 个或更多 CPU 的现代计算机上，可以同时运行多个线程。每个 CPU 都能够在任何给定时间运行一个线程。这意味着如果您的 Java 应用程序是多线程的，那么每个 CPU 可能同时（并发地）运行 Java 应用程序中的一个线程。</p><p>每个 CPU 包含一组寄存器，这些寄存器本质上是在 CPU 内存中。CPU 在这些寄存器上执行操作的速度要比在主内存中执行变量的速度快得多。这是因为 CPU 访问这些寄存器的速度要比访问主内存快得多。</p><p>每个 CPU 还可以有一个 CPU 缓存内存层。事实上，大多数现代 CPU 都有某种大小的缓存内存层。CPU 访问缓存内存的速度比主内存快得多，但通常没有访问内部寄存器的速度快。因此，CPU 高速缓存存储器介于内部寄存器和主存储器的速度之间。某些 CPU 可能有多个缓存层（L1 和 L2），但要了解 Java 内存模型如何与内存交互，这一点并不重要。重要的是要知道 CPU 可以有某种缓存存储层。</p><p>计算机还包含一个主内存区域（RAM）。所有 CPU 都可以访问主存，主内存区域通常比 CPU 的缓存内存大得多。</p><p>通常，当 CPU 需要访问主内存时，它会将部分主内存读入 CPU 缓存。它甚至可以将缓存的一部分读入内部寄存器，然后对其执行操作。当 CPU 需要将结果写回主内存时，它会将值从内部寄存器刷新到缓存内存，并在某个时候将值刷新回主内存。</p><p>当 CPU 需要在高速缓存中存储其他内容时，通常会将存储在高速缓存中的值刷新回主内存。CPU 缓存可以一次将数据写入一部分内存，并一次刷新一部分内存。它不必每次更新时都读取 / 写入完整的缓存。通常，缓存是在称为 “缓存线（Cache Line）” 的较小内存块中更新的。可以将一条或多条高速缓存线读入高速缓存内存，并将一条或多条高速缓存线再次刷新回主内存。</p><p>如前所述，JMM 和硬件内存结构是不同的。硬件内存体系结构不区分线程栈和堆。在硬件上，线程栈和堆都位于主内存中。线程栈和堆的一部分有时可能存在于 CPU 高速缓存和内部 CPU 寄存器中。如下图所示:</p><p><div class="sr-rd-content-center"><img class="" src="http://misc.linkedkeeper.com/misc/img/blog/201907/linkedkeeper0_039e4a23-14e5-4607-bf28-2ed285a18c03.jpg"></div></p><p>当对象和变量可以存储在计算机的不同内存区域时，可能会出现某些问题。主要有两个问题：</p><ul>
<li><p>线程更新（写入）对共享变量的可见性</p></li>
<li><p>读取、检查和写入共享变量时的竞争条件</p></li>
</ul><p>这两个问题将在下面几节中进行解释。</p><h2 id="sr-toc-0">共享对象的可见性</h2><p>如果两个或多个线程共享一个对象，而没有正确使用 volatile 声明或同步，那么一个线程对共享对象的更新可能对其他线程不可见。</p><p>假设共享对象最初存储在主内存中。在 CPU 1 上运行的线程然后将共享对象读入它的 CPU 缓存。在这里，它对共享对象进行更改。只要没有将 CPU 缓存刷新回主内存，在其他 CPU 上运行的线程就不会看到共享对象的更改版本。这样，每个线程都可能最终拥有自己的共享对象副本，每个副本位于不同的 CPU 缓 存中。</p><p>下图说明了大致的情况。在左 CPU 上运行的一个线程将共享对象复制到其 CPU 缓存中，并将其 count 变量更改为 2。此更改对运行在正确 CPU 上的其他线程不可见，因为尚未将更新刷新回主内存。</p><p><div class="sr-rd-content-center"><img class="" src="http://misc.linkedkeeper.com/misc/img/blog/201907/linkedkeeper0_c84e76a1-7ea8-4e58-a34c-6e8cad9c68fb.jpg"></div></p><p>要解决这个问题，可以使用 <a href="http://tutorials.jenkov.com/java-concurrency/volatile.html">Java 的 volatile 关键字</a>。volatile 关键字可以确保直接从主内存读取给定的变量，并在更新时始终将其写回主内存。</p><h2 id="sr-toc-1">竞态条件</h2><p>如果两个或多个线程共享一个对象，且多个线程更新该共享对象中的变量，则可能出现<a href="http://tutorials.jenkov.com/java-concurrency/race-conditions-and-critical-sections.html">竞争条件</a>。</p><p>假设线程 A 将共享对象的变量计数读入其 CPU 缓存。再想象一下，线程 B 执行相同的操作，但是进入了不同的 CPU 缓存。现在线程 A 向 count 加一，线程 B 也这样做。现在 var1 已经增加了两次，每次在每个 CPU 缓存中增加一次。</p><p>如果按顺序执行这些增量，变量计数将增加两次，并将原始值 + 2 写回主内存。</p><p>但是，这两个增量是同时执行的，没有适当的同步。无论哪个线程 A 和线程 B 将其更新版本的 count 写回主内存，更新后的值只比原始值高 1，尽管有两个增量。</p><p>该图说明了上述竞态条件问题的发生情况：</p><p><div class="sr-rd-content-center"><img class="" src="http://misc.linkedkeeper.com/misc/img/blog/201907/linkedkeeper0_0c4d3654-2adb-418a-9a7f-b2a177888bee.jpg"></div></p><p>要解决这个问题，可以使用 <a href="http://tutorials.jenkov.com/java-concurrency/synchronized.html">Java synchronized 块</a>。同步块保证在任何给定时间只有一个线程可以进入代码的给定临界段。Synchronized 块还保证在 Synchronized 块中访问的所有变量都将从主内存中读入，当线程退出 Synchronized 块时，所有更新的变量将再次刷新回主内存，而不管变量是否声明为 volatile。</p><h2 id="sr-toc-2">Reference</h2><p>http://tutorials.jenkov.com/java-concurrency/java-memory-model.html</p></sr-rd-content>
            <sr-rd-footer>
                <sr-rd-footer-group>
                    <sr-rd-footer-line></sr-rd-footer-line>
                    <sr-rd-footer-text>全文完</sr-rd-footer-text>
                    <sr-rd-footer-line></sr-rd-footer-line>
                </sr-rd-footer-group>
                <sr-rd-footer-copywrite>
                    <div>本文由 <a href="http://ksria.com/simpread" target="_blank">简悦 SimpRead</a> 转码，用以提升阅读体验，<a href="http://www.linkedkeeper.com/1502.html?hmsr=toutiao.io&utm_medium=toutiao.io&utm_source=toutiao.io" target="_blank">原文地址 </a></div>
                </sr-rd-footer-copywrite>
            </sr-rd-footer>
        </sr-read>
    </body>
    </html>
